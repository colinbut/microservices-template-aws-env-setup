AWSTemplateFormatVersion: 2010-09-09
Description: Template to create Environment resources for Microservices Template
Parameters:
  KeyName:
    Description: SSH access KeyPair
    # Type: AWS::EC2::KeyPair::KeyName
    Type: String
Mappings:
  RegionMap:
    us-east-1: # N. Virginia
      AMI: ami-0b898040803850657
    us-west-1: # N. California
      AMI: ami-056ee704806822732
    eu-west-1: # Ireland
      AMI: ami-0bbc25e23a7640b9b
    eu-west-2: # London
      AMI: ami-0d8e27447ec2c8410
    ap-southeast-2: # Sydney
      AMI: ami-0dc96254d5535925f
Resources:
  MicroservicesTemplateLB:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t2.micro
      ImageId:
        Fn::FindInMap:
          - RegionMap
          - !Ref AWS::Region
          - AMI
      SecurityGroupIds:
        - !Ref LoadBalancerSecurityGroup
      SubnetId: subnet-0aa5d098de37c2fae
      Tags:
        - Key: Name
          Value: MicroservicesTemplateLoadBalancer
      KeyName: !Ref KeyName
  MicroservicesTemplateWeb01:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t2.micro
      ImageId:
        Fn::FindInMap:
          - RegionMap
          - !Ref AWS::Region
          - AMI
      SecurityGroupIds:
        - !Ref WebDMZSecurityGroup
      SubnetId: subnet-0aa5d098de37c2fae
      Tags:
        - Key: Name
          Value: MicroservicesTemplateWeb01
      KeyName: !Ref KeyName
  MicroservicesTemplateWeb02:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t2.micro
      ImageId:
        Fn::FindInMap:
          - RegionMap
          - !Ref AWS::Region
          - AMI
      SecurityGroupIds:
        - !Ref WebDMZSecurityGroup
      SubnetId: subnet-0aa5d098de37c2fae
      Tags:
        - Key: Name
          Value: MicroservicesTemplateWeb02
      KeyName: !Ref KeyName
  MicroservicesTemplateWeb03:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t2.micro
      ImageId:
        Fn::FindInMap:
          - RegionMap
          - !Ref AWS::Region
          - AMI
      SecurityGroupIds:
        - !Ref WebDMZSecurityGroup
      SubnetId: subnet-0aa5d098de37c2fae
      Tags:
        - Key: Name
          Value: MicroservicesTemplateWeb03
      KeyName: !Ref KeyName
  WebDMZSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Enable Web Access and SSH 
      GroupName: WebDMZ
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 8080
          ToPort: 8080
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
      VpcId: vpc-08cad353dcbd8b3c8
  LoadBalancerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Enable Web Access and SSH
      GroupName: LoadBalancerDMZ
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
      VpcId: vpc-08cad353dcbd8b3c8
        